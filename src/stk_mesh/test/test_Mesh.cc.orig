#include <UnitTest++.h>

#include "../Mesh.hh"
#include "../Mesh_factory.hh"
#include "Element_block.hh"
#include "Coordinates.hh"
#include "Element_types.hh"
#include "Field_data.hh"

#include <stk_util/parallel/Parallel.hpp>

#include <Epetra_MpiComm.h>

#include <iostream>

/* Global node ordering
 *
 *      3       7      11      15      19         
 *      +-------+-------+-------+-------+        
 *     /       /       /       /       /|       
 *   4/      8/     12/     16/     20/ |       
 *   +-------+-------+-------+-------+  |       
 *   |       |       |       |       |  +18        Z  Y
 *   |  e1   |  e2   |  e3   |  e4   | /           | /
 *   |       |       |       |       |/            |/
 *   +-------+-------+-------+-------+             *--X
 *   1       5      9       13      17          
 *
 *  Local node numbering
 *      8       7
 *      +-------+
 *     /       /| 
 *   5/      6/ | 
 *   +-------+  |
 *   |       |  +3 
 *   |  e1   | /
 *   |       |/ 
 *   +-------+
 *   1       2  
 */

const int local_global_map [] = {1, 5, 6, 2, 4, 8, 7, 3};
void make_node_ids (int element_number, int node_ids [])
{
    const int base = 4*element_number;
    for (int node = 0; node < 8; ++node)
        node_ids [node] = base+local_global_map [node];
}

struct Test_mesh
{

    Mesh_data::Data *data;


    Test_mesh ()
    {
        const int element_block_id = 1;

        const int dimensions = 3;
        const int num_elements = 4;
        const int num_nodes = 20;
        const int num_blocks = 1;
        const int num_side_sets = 0;
        const int num_node_sets = 0;

        // Parameters
        Mesh_data::Parameters *parameters = 
            new Mesh_data::Parameters("Test mesh", 
                                      dimensions, 
                                      num_nodes, 
                                      num_elements, 
                                      num_blocks, num_side_sets, num_node_sets, 
                                      std::vector<int>(1,element_block_id),
                                      std::vector<int>(0),
                                      std::vector<int>(0));


        // Element block
        std::vector<int> connectivity (32);
        for (int element=0; element<4; ++element)
        {
            make_node_ids (element, &connectivity [element*8]);
        }
        std::vector<double> attributes(0);
        Mesh_data::Element_block* block = 
            Mesh_data::Element_block::build_from(element_block_id, 
                                                 num_elements, 
                                                 Mesh_data::HEX, 
                                                 connectivity, attributes);

        std::vector<Mesh_data::Element_block*> element_blocks(1, block);



        // Coordinates
        std::vector<std::vector<double> > coord_data (3, std::vector<double>(20));
        for (int node = 0; node < 20; ++node)
        {
            const int x_plane  = node / 4;
            const int in_plane = node % 4;
            const int y_plane = int ((in_plane == 1) || (in_plane == 2));
            const int z_plane = int ((in_plane == 2) || (in_plane == 3));

            coord_data [0] [node] = double (x_plane);
            coord_data [1] [node] = double (y_plane);
            coord_data [2] [node] = double (z_plane);
        }

        Mesh_data::Coordinates<double>* coordinates = Mesh_data::Coordinates<double>::build_from (coord_data);

        // Side sets
        std::vector<Mesh_data::Side_set*> side_sets(0);

        // Node sets
        std::vector<Mesh_data::Node_set*> node_sets(0);

        // Data container
        data = Mesh_data::Data::build_from(parameters, coordinates, element_blocks, side_sets, node_sets);

    }

};



TEST_FIXTURE (Test_mesh, Build)
{

    Mesh_data::Fields fields;

    int argc = 1;
    char **argv;
    argv = new char*[2];
    argv [0] = (char*)"random_dent.exe";
    argv [1] = NULL;

    stk::ParallelMachine parallel_machine = stk::parallel_machine_init (&argc, &argv);
    Epetra_MpiComm comm (parallel_machine);
    const unsigned int my_pid = comm.MyPID ();

    const int bucket_size = 20;
    STK_mesh::Mesh_factory factory(parallel_machine, bucket_size);
    STK_mesh::Mesh* mesh = factory.build_mesh (*data, fields);

    if (my_pid == 0)
    {
        CHECK_EQUAL (mesh->my_pid (), my_pid);
        CHECK_EQUAL (mesh->num_elements (), 4);
        CHECK_EQUAL (mesh->num_faces (), 21);
        CHECK_EQUAL (mesh->num_nodes (), 20);
    }
    else
    {
        CHECK_EQUAL (mesh->my_pid (), my_pid);
        CHECK_EQUAL (mesh->num_elements (), 0);
        CHECK_EQUAL (mesh->num_faces (), 0);
        CHECK_EQUAL (mesh->num_nodes (), 0);
    }

    



    stk::parallel_machine_finalize ();

}
